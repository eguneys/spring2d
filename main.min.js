var Space=function(){"use strict";class t{constructor(t,e,i){this.$wrap=t,this.width=e,this.height=i,this.$canvas=document.createElement("canvas"),this.$canvas.width=e,this.$canvas.height=i,t.appendChild(this.$canvas);let r=this.$canvas.getContext("webgl2",{alpha:!0,antialias:!1});null!==r&&(this.gl=r),this.$canvas.addEventListener("webglcontextlost",(t=>{console.log("context lost"),t.preventDefault(),this.gl=void 0})),this.$canvas.addEventListener("webglcontextrestored",(()=>{console.log("restored"),null!==r&&(this.gl=r)}))}}class e{constructor(t,e,i){this.uniformData=t,this.attributeData=e,this.program=i}}function i(t,i,n){const a=r(t,t.VERTEX_SHADER,i),h=r(t,t.FRAGMENT_SHADER,n),o=t.createProgram();t.attachShader(o,a),t.attachShader(o,h),t.linkProgram(o),t.getProgramParameter(o,t.LINK_STATUS)||function(t,e,i,r){t.getProgramParameter(e,t.LINK_STATUS)||(t.getShaderParameter(i,t.COMPILE_STATUS)||s(t,i),t.getShaderParameter(r,t.COMPILE_STATUS)||s(t,r),console.error("Iksir: Couldn't initialize shader"),""!==t.getProgramInfoLog(e)&&console.warn("Iksir: gl.getProgramInfoLog()",t.getProgramInfoLog(e)))}(t,o,a,h);let l=function(t,e){const i={},r=t.getProgramParameter(e,t.ACTIVE_ATTRIBUTES);for(let s=0;s<r;s++){const r=t.getActiveAttrib(e,s);if(0===r.name.indexOf("gl_"))continue;const n={tpe:"tpe",name:r.name,size:0,location:s};i[r.name]=n}return i}(t,o),c=function(t,e){const i={},r=t.getProgramParameter(e,t.ACTIVE_UNIFORMS);for(let s=0;s<r;s++){const r=t.getActiveUniform(e,s),n={name:r.name,location:-1,index:s};i[r.name]=n}return i}(t,o);const u=Object.keys(l);for(let e=0;e<u.length;e++)l[u[e]].location=e,t.bindAttribLocation(o,e,u[e]);t.linkProgram(o),t.deleteShader(a),t.deleteShader(h);for(let e in c)c[e],c[e].location=t.getUniformLocation(o,e);return new e(c,l,o)}function r(t,e,i){const r=t.createShader(e);return t.shaderSource(r,i),t.compileShader(r),r}function s(t,e){const i=t.getShaderSource(e).split("\n").map(((t,e)=>`${e}: ${t}`)),r=t.getShaderInfoLog(e),s=r.split("\n"),n={},a=s.map((t=>parseFloat(t.replace(/^ERROR\: 0\:([\d]+)\:.*$/,"$1")))).filter((t=>!(!t||n[t])&&(n[t]=!0,!0))),h=[""];a.forEach((t=>{i[t-1]=`%c${i[t-1]}%c`,h.push("background: #FF0000; color:#FFFFFF; font-size: 10px","font-size: 10px")}));const o=i.join("\n");h[0]=o,console.error(r),console.groupCollapsed("click to view full shader code"),console.warn(...h),console.groupEnd()}class n{constructor(t,e){this.quad=t,this.tint=e}}class a{get _flat(){return this.__flat||(this.__flat=[this,...this._children.flatMap((t=>t._flat))]),this.__flat}constructor(t=[],e=l.unit,i=l.unit){this._children=t,this.world=e,this._local=i}get quad(){return this.textint?.quad}get tint(){return this._tint}set quad(t){this.textint=new n(t,this._tint)}_tint=16777215;set tint(t){this._tint=t,this.textint&&(this.textint.tint=t)}size=h.unit;pivot=h.zero;scale=h.unit;rotation=0;translate=h.zero;get clone(){let t=new a([],this.world.clone,this._local.clone);return this._children.forEach((e=>e.clone._set_parent(t))),t.size=this.size.clone,t.pivot=this.pivot.clone,t.scale=this.scale.clone,t.rotation=this.rotation,t.translate=this.translate.clone,t.quad=this.quad,t.tint=this.tint,t._dirty_upto_parent(),t._update_world(),t}get local(){let{size:t,scale:e,rotation:i,translate:r,pivot:s}=this,n=e.mul(t);return this._local.transform_in(n,i,r,s),this._local}get x(){return this.translate.x}set x(t){this.translate.set_in(t,this.y)}get y(){return this.translate.y}set y(t){this.translate.set_in(this.x,t)}_dirty_upto_parent(){let t=this;do{t.__flat=void 0}while(t=t._parent)}_clean_children(){this._children.forEach((t=>t.parent=void 0)),this._children.splice(0),this._dirty_upto_parent()}_set_parent(t){t._children.push(this),this._parent=t,this._dirty_upto_parent()}get _next_sibling(){return this._parent._children[this._parent._children.indexOf(this)+1]}get _first_child(){return this._children[0]}_insert_before(t,e){if(t===e)return;t._remove();let i=this._children.indexOf(e);-1===i&&(i=this._children.length),this._children.splice(i,0,t),t._parent=this,t._dirty_upto_parent()}_replace_child(t,e){t._remove(),this._children.splice(this._children.indexOf(e),1,t),e._parent=void 0,t._parent=this,t._dirty_upto_parent()}_remove(){this._parent&&(this._parent._children.splice(this._parent._children.indexOf(this),1),this._parent._dirty_upto_parent(),this._parent=void 0)}_update_world(t){t?(this.world.set_in(t),this.world.mul_in(this.local)):this.world.set_in(this.local);let{world:e}=this;this._children.forEach((t=>t._update_world(e)))}}class h{static from_angle=t=>new h(Math.cos(t),Math.sin(t));static make=(t,e)=>new h(t,e);static get unit(){return new h(1,1)}static get zero(){return new h(0,0)}get vs(){return[this.x,this.y]}get mul_inverse(){return new h(1/this.x,1/this.y)}get inverse(){return new h(-this.x,-this.y)}get half(){return new h(this.x/2,this.y/2)}get length_squared(){return this.x*this.x+this.y*this.y}get length(){return Math.sqrt(this.length_squared)}get normalize(){return 0===this.length?h.zero:this.scale(1/this.length)}get perpendicular(){return new h(-this.y,this.x)}get clone(){return new h(this.x,this.y)}get angle(){return Math.atan2(this.y,this.x)}constructor(t,e){this.x=t,this.y=e}dot(t){return this.x*t.x+this.y*t.y}cross(t){return this.x*t.y-this.y*t.x}project_to(t){let e=t.length_squared,i=this.dot(t);return h.make(i*t.x/e,i*t.y/e)}distance(t){return this.sub(t).length}addy(t){return h.make(this.x,this.y+t)}add_angle(t){return h.from_angle(this.angle+t)}scale(t){let{clone:e}=this;return e.scale_in(t)}scale_in(t){return this.x*=t,this.y*=t,this}add(t){let{clone:e}=this;return e.add_in(t)}add_in(t){return this.x+=t.x,this.y+=t.y,this}sub(t){let{clone:e}=this;return e.sub_in(t)}sub_in(t){return this.x-=t.x,this.y-=t.y,this}mul(t){let{clone:e}=this;return e.mul_in(t)}mul_in(t){return this.x*=t.x,this.y*=t.y,this}div(t){let{clone:e}=this;return e.div_in(t)}div_in(t){return this.x/=t.x,this.y/=t.y,this}set_in(t,e=this.y){return this.x=t,this.y=e,this}}class o{static make=(t,e,i,r)=>new o([h.make(t,e),h.make(t+i,e),h.make(t+i,e+r),h.make(t,e+r)]);static get unit(){return o.make(0,0,1,1)}get vs(){let{x:t,y:e,w:i,h:r}=this;return[t,e,i,r]}get x1(){return this.vertices[0].x}get y1(){return this.vertices[0].y}get x2(){return this.vertices[2].x}get y2(){return this.vertices[2].y}get x(){return this.x1}get y(){return this.y1}get w(){return this.x2-this.x1}get h(){return this.y2-this.y1}get vertexData(){return new Float32Array(this.vertices.flatMap((t=>t.vs)))}get indices(){return new Uint16Array([0,1,2,0,2,3])}constructor(t){this.vertices=t}transform(t){return new o(this.vertices.map((e=>t.mVec2(e))))}}class l{static get identity(){return new l(1,0,0,1,0,0)}static get unit(){return l.identity}static projection=(t,e)=>new l(1/t*2,0,0,-1/e*2,-1,1);get clone(){let{a:t,b:e,c:i,d:r,tx:s,ty:n}=this;return new l(t,e,i,r,s,n)}get inverse(){let{a:t,b:e,c:i,d:r,tx:s,ty:n}=this,a=t*r-e*i;return new l(r/a,-e/a,-i/a,t/a,(i*n-r*s)/a,-(t*n-e*s)/a)}constructor(t,e,i,r,s,n){this.a=t,this.b=e,this.c=i,this.d=r,this.tx=s,this.ty=n,this.array_t=new Float32Array([t,e,0,i,r,0,s,n,1])}rotate_in(t){let e=Math.cos(t),i=Math.sin(t),r=this.a*e-this.b*i,s=this.a*i+this.b*e,n=this.c*e-this.d*i,a=this.c*i+this.d*e,h=this.tx*e-this.ty*i,o=this.tx*i+this.ty*e;this.a=r,this.b=s,this.c=n,this.d=a,this.tx=h,this.ty=o}rotate(t){let{clone:e}=this;return e.rotate_in(t),e}scale(t,e){let i=this.a*t,r=this.b,s=this.c,n=this.d*e,a=this.tx,h=this.ty;return new l(i,r,s,n,a,h)}translate_in(t,e){this.a,this.b,this.c,this.d;let i=t+this.tx,r=e+this.ty;this.tx=i,this.ty=r}translate(t,e){let{clone:i}=this;return i.translate_in(t,e),i}scale_in(t,e){this.a=t,this.d=e}mVec2(t){let e=this.a,i=this.b,r=this.c,s=this.d,n=this.tx,a=this.ty,o=e*t.x+r*t.y+n,l=i*t.x+s*t.y+a;return h.make(o,l)}mul_in(t){let{a:e,b:i,c:r,d:s,tx:n,ty:a}=this;this.a=t.a*e+t.b*r,this.b=t.a*i+t.b*s,this.c=t.c*e+t.d*r,this.d=t.c*i+t.d*s,this.tx=t.tx*e+t.ty*r+n,this.ty=t.tx*i+t.ty*s+a}set_in(t){let{a:e,b:i,c:r,d:s,tx:n,ty:a}=t;this.a=e,this.b=i,this.c=r,this.d=s,this.tx=n,this.ty=a}transform_in(t,e,i,r=h.half){this.a=Math.cos(e)*t.x,this.b=Math.sin(e)*t.x,this.c=-Math.sin(e)*t.y,this.d=Math.cos(e)*t.y,this.tx=i.x-(r.x*this.a+r.y*this.c),this.ty=i.y-(r.x*this.b+r.y*this.d)}}function c(t){return[(16711680&t)>>16,(65280&t)>>8,255&t].map((t=>t/255))}class u{get gl(){return this.canvas.gl}get width(){return this.canvas.width}get height(){return this.canvas.height}constructor(t){this.canvas=t,this.projectionMatrix=l.projection(this.width,this.height)}glOnce=(t={})=>{let{gl:e}=this;if(!e)return;let{color:i}=t;e.viewport(0,0,this.width,this.height),e.clearColor(...c(i||0),1),e.enable(e.BLEND),e.blendFunc(e.ONE,e.ONE_MINUS_SRC_ALPHA)};glProgram=(t,e,r)=>{let{gl:s}=this,{program:n,uniformData:a,attributeData:h}=i(s,t,e),o=s.createVertexArray();s.bindVertexArray(o);let l=s.createBuffer();s.bindBuffer(s.ARRAY_BUFFER,l),s.bufferData(s.ARRAY_BUFFER,6*r*4,s.DYNAMIC_DRAW);let c=s.createBuffer();s.bindBuffer(s.ELEMENT_ARRAY_BUFFER,c),s.bufferData(s.ELEMENT_ARRAY_BUFFER,3*r*4,s.DYNAMIC_DRAW);let u=h.aVertexPosition.location;s.enableVertexAttribArray(u),s.vertexAttribPointer(u,2,s.FLOAT,!1,28,0);let _=h.aTextureCoord.location;s.enableVertexAttribArray(_),s.vertexAttribPointer(_,2,s.FLOAT,!1,28,8);let d=h.aTint.location;return s.enableVertexAttribArray(d),s.vertexAttribPointer(d,3,s.FLOAT,!1,28,16),s.bindVertexArray(null),{program:n,uniformData:a,indexBuffer:c,attributeBuffer:l,vao:o}};glTexture(){let{gl:t}=this,e=t.createTexture();return t.bindTexture(t.TEXTURE_2D,e),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,1,1,0,t.RGBA,t.UNSIGNED_BYTE,new Uint8Array([0,0,255,255])),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),{glTexture:e}}glUseTexture(t,e){let{gl:i}=this;i.bindTexture(i.TEXTURE_2D,t),i.texImage2D(i.TEXTURE_2D,0,i.RGBA,e.width,e.height,0,i.RGBA,i.UNSIGNED_BYTE,e)}glUse(t,e){let{gl:i}=this;i.useProgram(t),i.uniformMatrix3fv(e.projectionMatrix.location,!1,this.projectionMatrix.array_t)}glUniformUpdate(t,e){}glAttribUpdate(t,e){let{gl:i}=this;i.bindBuffer(i.ARRAY_BUFFER,t),i.bufferSubData(i.ARRAY_BUFFER,0,e,0)}glIndexUpdate(t,e){let{gl:i}=this;i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,t),i.bufferSubData(i.ELEMENT_ARRAY_BUFFER,0,e,0)}glClear(){let{gl:t}=this;t.clear(t.COLOR_BUFFER_BIT)}glDraw(t,e){let{gl:i}=this;i.bindVertexArray(e),i.drawElements(i.TRIANGLES,t,i.UNSIGNED_SHORT,0)}}class _{static make=(t,e,i,r=t.width,s=t.height)=>new _(t,o.make(e,i,r,s));get w(){return this._frame.w}get h(){return this._frame.h}get x0(){return this.frame.x}get y0(){return this.frame.y}get x1(){return this.frame.x2}get y1(){return this.y0}get x2(){return this.x1}get y2(){return this.frame.y2}get x3(){return this.x0}get y3(){return this.y2}constructor(t,e){this.texture=t,this._frame=e,this.tw=t.width,this.th=t.height,this.frame=e.transform(l.unit.scale(1/this.tw,1/this.th)),this.fsUv=new Float32Array([this.x0,this.y0,this.x1,this.y1,this.x2,this.y2,this.x3,this.y3])}}let d=/^[A-Za-z0-9\+\-;'\\\[\]]$/,g=/^(\s|Shift|ArrowUp|ArrowDown|ArrowLeft|ArrowRight|Backspace|Enter|Tab|\*)$/,x=/^(\!|\$)$/;function f(t){return t.match(d)||t.match(g)||t.match(x)}class v{get left(){return this.btn("left")}get right(){return this.btn("right")}_btn=new Map;press=(t,e)=>{let i=e.ctrlKey,r=e.shiftKey;this._btn.has(t)?this._btn.get(t).just_pressed=!0:this._btn.set(t,{just_pressed:!0,just_released:!1,ctrl:i,shift:r,t:0,t0:0})};release=t=>{let e=this._btn.get(t);e&&(e.just_released=!0)};btn=(t,e,i)=>{let r=this._btn.get(t);return r&&!!e==!!r.shift?r.t:0};btn0=(t,e,i)=>{let r=this._btn.get(t);return r&&!!e==!!r.shift?r.t0:0};btnp=(t,e,i)=>this.btn(t,e,i)>0&&0===this.btn0(t,e,i);btnpp=t=>this._btnpp===t;update=(t,e)=>{this._btnpp=void 0;for(let[e,i]of this._btn)0===i.t&&(i.t0=i.t),(i.just_pressed||i.t>0)&&(i.t0=i.t,i.t+=t,i.just_pressed=!1),i.just_released&&(i.t0=i.t,i.t=0,i.just_released=!1,this._last_released&&this._last_released===e?(this._btnpp=e,this._last_released=void 0):this._last_released=e)};init(){let{press:t,release:e}=this;return document.addEventListener("keydown",(e=>{if(!e.ctrlKey&&f(e.key))switch(e.preventDefault(),e.key){case"ArrowUp":t("up",e);break;case"ArrowDown":t("down",e);break;case"ArrowLeft":t("left",e);break;case"ArrowRight":t("right",e);break;default:t(e.key,e)}})),document.addEventListener("keyup",(t=>{if(!t.ctrlKey&&f(t.key))switch(t.preventDefault(),t.key){case"ArrowUp":e("up");break;case"ArrowDown":e("down");break;case"ArrowLeft":e("left");break;case"ArrowRight":e("right");break;default:e(t.key)}})),this}}class m{_wheel=0;_wheel0=0;get bounds(){return this._bounds||(this._bounds=this.$canvas.getBoundingClientRect()),this._bounds}get wheel(){return this._wheel}get drag(){if(this._drag?.move)return this._drag}get click(){if(!this._drag?.move&&this._drag?.drop)return this._drag.drop}get lclick(){if(0===this._drag?.button)return this.click}get rclick(){if(2===this._drag?.button)return this.click}get click_down(){if(!this._drag0&&this._drag&&!this._drag?.move&&!this._drag?.drop)return this._drag.start}get hover(){if(!this._drag)return this._hover}get drag_delta(){if(this._drag?.move)return[this._drag.move[0]-this._drag.start[0],this._drag.move[1]-this._drag.start[1]]}constructor(t){this.$canvas=t}eventPosition(t){let e=function(t){return void 0!==t.clientX&&void 0!==t.clientY?[t.clientX,t.clientY]:t.targetTouches?.[0]?[t.targetTouches[0].clientX,t.targetTouches[0].clientY]:void 0}(t),{bounds:i}=this,r=64/i.width,s=64/i.height;return e&&(e[0]-=i.left,e[1]-=i.top,e[0]*=r,e[1]*=s),e}disposes=[];dispose(){this.disposes.forEach((t=>t()))}init(){let{$canvas:t,disposes:e}=this;t.addEventListener("wheel",(t=>{this._wheel=Math.sign(t.deltaY)})),t.addEventListener("mousedown",(t=>{this._drag||(this._drag1={button:t.button,start:this.eventPosition(t)})})),t.addEventListener("mousemove",(t=>{this._drag?this._drag.r_move=this.eventPosition(t):this._hover=this.eventPosition(t)})),t.addEventListener("contextmenu",(t=>{t.preventDefault(),this._drag||(this._drag1={button:t.button,start:this.eventPosition(t)})}));let i=t=>{this._drag&&(this._drag.drop=this.eventPosition(t),this._drop0=this._drag)};document.addEventListener("mouseup",i),e.push((()=>document.removeEventListener("mouseup",i)));const r=()=>{this._bounds=void 0};return window.addEventListener("resize",r),document.addEventListener("scroll",r),e.push((()=>window.removeEventListener("resize",r))),e.push((()=>document.removeEventListener("scroll",r))),this}update(t,e){this._wheel0===this._wheel?this._wheel=0:this._wheel0=this._wheel,this._drag&&(this._drag.move0=this._drag.move,void 0!==this._drag.r_move&&(this._drag.move||function(t,e){let i=t[0]-e[0],r=t[1]-e[1];return Math.sqrt(i*i+r*r)>3}(this._drag.r_move,this._drag.start))&&(this._drag.move=this._drag.r_move),this._drop0?this._drop0=void 0:this._drag.drop&&(this._drag1=void 0)),this._drag0=this._drag,this._drag1!==this._drag&&(this._drag=this._drag1)}}const p=1e3/60,A=60*p;function y(t,e,i,r,s){return{max_force:s,max_speed:r,air_friction:i,mass:e,force:0,x:t,x0:t,vx:0}}function b(t,e){let i=e*e/(t*t);return i=i>1?1:Math.sqrt(i),t*i}function w(t,e,i){let{air_friction:r,force:s,mass:n,max_speed:a,max_force:h}=t,{x:o,x0:l}=t,c=s/n;c=b(c,h);let u=(o-l)*r*e/i+c*e*(e+i)/2;u=b(u,a);let _=o,d=o+u;t.x0=_,t.x=d,t.vx=u}class E{static make=(t,e,i)=>new E(h.make(t,e),i);get x(){return this.r_x.x}get y(){return this.r_y.x}get pos(){return this.vs.set_in(this.x,this.y),this.vs}get velocity(){return this.v_vx.set_in(this.r_x.vx,this.r_y.vx),this.v_vx}get max_speed(){return this.opts.max_speed}get heading(){return 0===this.velocity.x&&0===this.velocity.y?this._heading0||(this._heading0=h.make(1,0)):this._heading0=this.velocity.normalize,this._heading0}get side(){return this.heading.perpendicular}get matrix(){return function(t,e,i){let r=t.x,s=e.x,n=t.y,a=e.y,h=i.x,o=i.y;return new l(r,s,n,a,h,o)}(this.heading,this.side,this.pos)}constructor(t,e){this.vs=t,this.opts=e,this.v_vx=h.zero,this.r_x=y(t.x,e.mass,e.air_friction,e.max_speed,e.max_force),this.r_y=y(t.y,e.mass,e.air_friction,e.max_speed,e.max_force)}update(t,e){if(this.r_x.force=0,this.r_y.force=0,this.v_seek){let t=R(this.pos,this.v_seek,this.max_speed).sub(this.velocity);this.r_x.force=t.x,this.r_y.force=t.y}if(this.v_arrive){let t=function(t,e,i,r){let s=e.sub(t),n=s.length;if(0===n)return h.zero;let a=i*(n/r),o=Math.min(a,i);return s.scale_in(o/n)}(this.pos,this.v_arrive,this.max_speed,16).sub(this.velocity);this.r_x.force=t.x,this.r_y.force=t.y}if(this.v_pursuit){let t=function(t,e,i,r){let s=.08*t.distance(e),n=e.add(r.normalize.scale(s));return R(t,n,i)}(this.pos,this.v_pursuit,this.max_speed,this.v0_pursuit?this.v_pursuit.sub(this.v0_pursuit):h.zero).sub(this.velocity);this.r_x.force=t.x,this.r_y.force=t.y,this.v0_pursuit?this.v0_pursuit.set_in(this.v_pursuit.x,this.v_pursuit.y):this.v0_pursuit=this.v_pursuit.clone}if(this.v_evosion){let t=function(t,e,i,r,s){let n=t.distance(e);if(n>s)return h.zero;let a=.08*n,o=e.add(r.normalize.scale(a));return function(t,e,i){return t.sub(e).normalize.scale_in(i)}(t,o,i)}(this.pos,this.v_evosion,this.max_speed,this.v0_evosion?this.v_evosion.sub(this.v0_evosion):h.zero,2e4);if(t){let e=t.sub(this.velocity);e=e.scale(this.r_x.max_force/this.r_x.max_speed),this.r_x.force+=e.x,this.r_y.force+=e.y,this.v0_evosion?this.v0_evosion.set_in(this.v_evosion.x,this.v_evosion.y):this.v0_evosion=this.v_evosion.clone}}if(this.v_wander){let t=function(t,e,i,r,s){e.x+=(1-2*Math.random())*i,e.y+=(1-2*Math.random())*i;let n=(e=e.normalize).scale(r).add(h.make(s,0));return t.mVec2(n).sub(T(t))}(this.matrix,this.v_wander,20,400,60).sub(this.velocity);t=t.scale(this.r_x.max_force/this.r_x.max_speed),this.r_x.force+=t.x,this.r_y.force+=t.y}if(this.v_separation){let t=function(t,e){let i=h.make(0,0);return e.forEach((e=>{let r=T(t).sub(T(e));0===r.length&&(r=h.unit),i.add_in(r.normalize.scale(1e6/r.length))})),console.log(i),i}(this.matrix,this.v_separation).sub(this.velocity);t=t.scale(this.r_x.max_force/this.r_x.max_speed),this.r_x.force+=t.x,this.r_y.force+=t.y}{let t=function(t,e,i){let r=T(t),s=(n=t,h.make(n.a,n.c));var n;!function(t){h.make(t.b,t.d)}(t);let a,o,l,c,u=[];return u.push(s.scale(e).add_in(r)),u.push(s.add_angle(.25*-Math.PI).scale_in(e/2).add_in(r)),u.push(s.add_angle(.25*Math.PI).scale_in(e/2).add_in(r)),u.forEach((t=>{if(i.forEach((e=>{let i=e.intersects(k.make(r,t));if(i){let[t,r]=i;(!o||t<o)&&(o=t,l=e,c=r)}})),l){let e=t.sub(c);a=l.normal.scale(e.length)}})),a}(this.matrix,4e3,[k.from_xy(64e3,0,64e3,64e3),k.from_xy(0,64e3,0,0),k.from_xy(0,0,64e3,0),k.from_xy(64e3,64e3,0,64e3)]);if(t){this.v_wander.set_in(0,0);let e=t.sub(this.velocity);e=e.scale(this.r_x.max_force/this.r_x.max_speed),this.r_x.force=e.x,this.r_y.force=e.y}}w(this.r_x,t,e),w(this.r_y,t,e)}}function T(t){return h.make(t.tx,t.ty)}function R(t,e,i){return e.sub(t).normalize.scale_in(i)}class k{static make=(t,e)=>new k(t,e);static from_xy=(t,e,i,r)=>k.make(h.make(t,e),h.make(i,r));constructor(t,e){this.a=t,this.b=e,this.parallel=e.sub(t).normalize,this.normal=this.parallel.perpendicular}intersects(t){let{a:e,b:i}=this,{a:r,b:s}=t,n=(e.y-r.y)*(s.x-r.x)-(e.x-r.x)*(s.y-r.y),a=(i.x-e.x)*(s.y-r.y)-(i.y-e.y)*(s.x-r.x),h=(e.y-r.y)*(i.x-e.x)-(e.x-r.x)*(i.y-e.y),o=(i.x-e.x)*(s.y-r.y)-(i.y-e.y)*(s.x-r.x);if(0===a||0===o)return;let l=n/a,c=h/o;if(l>0&&l<1&&c>0&&c<1){return[e.distance(i)*l,e.add(i.sub(e).scale_in(l))]}}}let U,D,F,P,S=new a,M=[];function L(t){return M.push(t),()=>{M.splice(M.indexOf(t),1)}}function B(t){t.forEach((t=>t())),t.length=0}function z(t,e,i,r,s=U){let n=S.clone;return n.quad=_.make(P,t,e,i,r),s&&n._set_parent(s),n}class I{constructor(){this.cursor=function(){let t=S.clone;z(0,0,1,1,t).size=h.make(1,1);let e=z(0,0,1,1,t);e.size=h.make(1,1),e.x=-1,e.y=-1,t._set_parent(U);let i=0,r=0;return L(((e,s)=>{let{hover:n}=F;n&&(i=n[0],r=n[1]),t.x=i,t.y=r})),{get x(){return i},get y(){return r}}}();let t=z(0,0,1,1);t.size=h.make(1,1),t.x=32,t.y=32,t._set_parent(U);let e=[];e.push(j(this)),L(((t,i)=>{if(D.btnp("z")){B(e);for(let t=0;t<10;t++)e.push(j(this))}}))}}function N(t,e,i,r){U=t,D=i,P=e,F=r,z(2,2,1,1).size=h.make(64,64),new I}let C=[];function j(t){let e=S.clone;z(0,4,1,1,e).size=h.make(2,2),e._set_parent(U);let i=E.make(32e3,32e3,{mass:1e3,air_friction:.8,max_speed:800,max_force:200});i.v_evosion=h.make(0,0),i.v_wander=h.make(0,0),i.v_pursuit=h.make(0,0);let r=0,s=[],n=L(((n,a)=>{i.v_separation=C.filter((t=>t!==i)).map((t=>t.matrix)),(r+=n)>4*A&&(i.v_pursuit?i.v_pursuit=void 0:i.v_pursuit=h.make(0,0),r=0),i.v_evosion.set_in(1e3*t.cursor.x,1e3*t.cursor.y),i.v_pursuit?.set_in(1e3*t.cursor.x,1e3*t.cursor.y),i.update(n,a),e.x=i.x/1e3,e.y=i.y/1e3,B(s),s.push(function(t,e,i,r){let s=S.clone,n=h.make(i,r).normalize;for(let t=0;t<3;t++){let e=n.scale(t),i=z(0,4,1,1,s);i.size=h.unit,i.x=e.x,i.y=e.y}return s._set_parent(U),s.x=t,s.y=e,()=>{s._remove()}}(i.x/1e3,i.y/1e3,i.side.x/1e3,i.side.y/1e3))}));return C.push(i),()=>{n(),B(s),e._remove(),C.splice(C.indexOf(i),1)}}return function(e){var i;(i="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAQAAAAEACAMAAABrrFhUAAAAAXNSR0IArs4c6QAAAFdQTFRFAAAAAAAAACAzBExME3BWGiFcIxZbIycxMZ9yMlaQQCRxQqI9SAg2TbDIcH6Aes5KfrrOjk2unFtQqGZjvD5byP/S3aXn4f+N8JaM8Luc/825/+G8////fcUbnAAAAAF0Uk5TAEDm2GYAAAHKSURBVHja7ddpb4QgEABQpvd93+X//86maepaBHU3bVLje1+IYod1GIGmnK+ujo8j0lqtPgGPjycnBwf7+xKwVs/P19fn53t7ErBW7++vr/f3d3cSsFZvby8vDw8XFxKwVk9Pt7dnZ0dHErBWNzeXl6enh4cSAHyJT7029a6n+ifaQfxU+ftUjLNF/GrbDTw7ATnn6LfRXUeM9keu9nf3o4wfRfzveNEYv4w30X493w08PwGDgNG4jmp/dC8W4wmY+yLRijfeRuyagHLGo0jMd9wuflQzHpvn6nGiUTlRrbhNvNYLDyon/rwC0tgPGf7gmDXTuZjpYiYnP7X4GW+HNSDy+DeYJ0o6F5USE99wUSFRr4QuAdFYKxqJ2b4C5q/y1edjYtcYeS6lxngpFQNWdotf2wVwENq6hEc/heUlYLCItQ4ircWwWISWl4DNdpb620o0t8do9C87Ab2DzI+TT3umW9vQwr6E4cmqmOFGRWwSUD63sDy0Znhypov7vYTsdB75N/8OD1f1efd718l5BAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACW7ANrJTE3uGKBsgAAAABJRU5ErkJggg==",new Promise((t=>{let e=new Image;e.onload=()=>t(e),e.src=i}))).then((i=>{let[r,s,n]=((e,i,r,s)=>{let n=new t(e,r,s),h=new u(n);h.glOnce(),h.glClear();let l=new a,_=256e3,{program:d,uniformData:g,indexBuffer:x,attributeBuffer:f,vao:v}=h.glProgram("#version 300 es\nin vec3 aTint;\nin vec2 aVertexPosition;\nin vec2 aTextureCoord;\n\nuniform mat3 projectionMatrix;\n\nout vec2 vTextureCoord;\nout vec3 vTint;\n\nvoid main() {\n  gl_Position = vec4((projectionMatrix * vec3(aVertexPosition, 1.0)).xy, 0, 1);\n\n  vTextureCoord = aTextureCoord;\n  vTint = aTint;\n}\n","#version 300 es\nprecision highp float;\n\nin vec3 aTint;\nin vec2 vTextureCoord;\nin vec3 vTint;\nout vec4 outColor;\n\nuniform sampler2D uSampler;\n\nvoid main() {\n  //outColor = vec4(1.0, 1.0, 0.0, 1.0);\n  vec4 color = texture(uSampler, vTextureCoord);\n  color.rgb *= vTint;\n  outColor = vec4(color.rgb * color.a, color.a);\n}\n\n",_),m=new Uint16Array(3*_),p=new Float32Array(6*_),{glTexture:A}=h.glTexture();return h.glUseTexture(A,i),[(t,e)=>{h.glClear(),h.glUse(d,g);let i=0,r=0,s=0;for(let t=0;t<l._flat.length;t++){let e=l._flat[t],{world:n,quad:a,tint:h}=e;if(!a)continue;let{vertexData:u,indices:_}=o.unit.transform(n),{texture:d,fsUv:g}=a,x=c(h);for(let t=0;t<u.length;t+=2)p[i++]=u[t],p[i++]=u[t+1],p[i++]=g[t],p[i++]=g[t+1],p[i++]=x[0],p[i++]=x[1],p[i++]=x[2];for(let t=0;t<_.length;t++)m[r++]=4*s+_[t];s++}let n=!1;for(let t=l._flat.length-1;t>=0;t--){let e=l._flat[t];n||=e.on_event?.()}h.glAttribUpdate(f,p),h.glIndexUpdate(x,m),h.glDraw(6*s,v)},l,n.$canvas]})(e,i,64,64),h=(new v).init(),l=new m(n).init();N(s,i,h,l),function(t){let e,i,r=1e3/60,s=r;e=requestAnimationFrame((function n(a){let h=i?a-i:r;h=Math.min(33.333333333333336,Math.max(16.666666666666668,h)),t(h,s),s=h,i=a,e=requestAnimationFrame(n)}))}(((t,e)=>{h.update(t,e),l.update(t,e),function(t,e){M.forEach((i=>i(t,e)))}(t,e),s._update_world(),r()}))}))}}();
